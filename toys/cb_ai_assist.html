<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>CB Assistant</title>
  <style>
  body {
    background: black;
    color: white;
    margin-left: 1rem;
    margin-right: 1rem;
    user-select: none;
    font-weight: bold;
    font-size: 1.3rem;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  }

  button {
    font-size: 1.1rem;
    font-weight: bold;
  }

  a {
    text-decoration: none;
    color: dodgerblue;
  }

  #settings, #help, #about {
    text-align: center;
    margin-top: 2.2rem;
  }

  #about {
    line-height: 3rem;
  }

  #help {
    line-height: 1.5rem;
  }

  #testResults {
    width: 100%;
  }

  .row {
    margin-bottom: 2px;
    padding: 0.5rem;
    border: 1px solid silver;
    width: 16rem;
    display: none;
  }

  .score {
    float: right;
  }

  .correct, .misplaced {
    font-weight: bold;
    font-size: 1.5rem;
    text-align: center;
    width: 1.5rem;
    color: white;
  }

  .correct {
    background: green;
    border: 1px solid green;
    margin-top: -0.2rem;
  }

  .misplaced {
    background: red;
    border: 1px solid red;
    margin-top: 0.2rem;
  }

  /*
   * Based on https://css-tricks.com/snippets/css/css-triangle/
   */

  .up {
    width: 0; 
    height: 0;
    display: inline-block;
    margin-top: 0.5rem;
    margin-bottom: 1.5rem;
    margin-left: 0.25rem;
    margin-right: 0.25rem;
    border-left: 1.5rem solid transparent;
    border-right: 1.5rem solid transparent;

    border-bottom: 1.5rem solid yellow;
  }

  .down {
    width: 0; 
    height: 0;
    display: inline-block;
    margin-top: 2rem;
    margin-left: 0.25rem;
    margin-right: 0.25rem;
    border-left: 1.5rem solid transparent;
    border-right: 1.5rem solid transparent;

    border-top: 1.5rem solid yellow;
  }

  .left {
    width: 0; 
    height: 0;
    display: inline-block;
    margin-top: 0.5rem;
    margin-left: 0.75rem;
    margin-right: 1.25rem;
    border-top: 1.5rem solid transparent;
    border-bottom: 1.5rem solid transparent;

    border-right: 1.5rem solid blue;
  }

  .right {
    width: 0; 
    height: 0;
    display: inline-block;
    margin-top: 0.5rem;
    margin-left: 1.25rem;
    margin-right: 0.75rem;
    border-top: 1.5rem solid transparent;
    border-bottom: 1.5rem solid transparent;

    border-left: 1.5rem solid blue;
  }

  .status {
    width: 15rem;
    padding: 0.5rem 0.95rem;
    font-size: 1.2rem;
    font-weight: bold;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    color: black;
  }

  .failure {
    background: lightpink;
    border-left: 4.1px solid red;
  }

  .success {
    background: lightgreen;
    border-left: 4.1px solid green;
  }

  .warning {
    background: yellow;
    color: black;
    border-left: 4.1px solid lightyellow;
  }
  </style>
</head>
<body>
<div id="controls">
  <button id="moreOptions" onclick="moreOptions()">More</button>
  &nbsp;
  <button id="auto" onclick="initAutomation()">Auto</button>
  &nbsp;
  <button id="next" onclick="nextGuess()">Next</button>

  <br/>

  <div id="more" style="display:none">
    <button id="settingsBtn" onclick="display('settings')">Settings</button>
    <br/>
    <button id="helpBtn" onclick="display('help')">Help</button>
    <br/>
    <button id="aboutBtn" onclick="display('about')">About</button>
  </div>
</div>

<div id="container">
  <div class="row">
    <span class="score"> 
      <div class="correct selected" onclick="bumpScore(this)">0</div> 
      <div class="misplaced" onclick="bumpScore(this)">0</div>
    </span> 
  </div>
</div>

<div id="settings" style="display:none">
  <span>Theme</span>

  <br/>

  <label for="dark">
    <input type="radio" name="theme" id="dark" onchange="updateTheme('dark')" checked>
    Dark
  </label>
  <label for="light">
    <input type="radio" name="theme" id="light" onchange="updateTheme('light')">
    Light
  </label>

  <br/>
  <br/>

  <button onclick="selfTest()">Self-Test</button>
  
  <br/>
  <br/>

  <textarea id="testResults" rows="10"></textarea>
</div>

<div id="help" style="display:none">
  <p>Press Auto to reset the board and generate a random guess.</p>
  <p>Click to add 1 correct (green), or 1 misplaced (red).</p>
  <p>When at max (4), click will reset number to 0.</p>
  <p>Shift + click to subtract 1 instead.</p>
  <p>When at minimum (0), shift + click will set number to 4.</p>
</div>

<div id="about" style="display:none">
  <p>Made for use with Chrome</p>

  <p>Partially based on <a href="https://nebupookins.github.io/JS-Mastermind-Solver/">JS-Mastermind-Solver</a> by <a href="https://github.com/nebupookins">nebupookins</a></p>

  <p>Built with <span style="color:red;font-size:2rem;vertical-align:sub">&hearts;</span> by <a href="https://github.com/l3laze">l3l_aze</a></p>
</div>

<script>
function bumpScore (what, how) {
  let score = parseInt(what.innerText)
  const shift = event.shiftKey

  if ((!shift && typeof how === 'undefined') && score === 4) {
    score = 0
  } else if (shift || how === 'minus') {
    score--

    if(score < 0) {
      score = 4
    }
  } else {
    score++
  }

  what.innerText = score
}

function addRow () {
  const d = document.createElement('div')
  const s = document.createElement('span')
  const c = document.createElement('div')
  const i = document.createElement('div')

  d.classList.add('row')
  s.classList.add('score')
  c.classList.add('correct', 'selected')
  i.classList.add('misplaced')

  c.addEventListener('click', function () {
    bumpScore(c)
  })

  i.addEventListener('click', function () {
    bumpScore(i)
  })

  c.appendChild(document.createTextNode('0'))
  i.appendChild(document.createTextNode('0'))

  s.appendChild(c)
  s.appendChild(i)
  d.appendChild(s)

  const t = document.getElementById('container')

  t.appendChild(document.createElement('br'))

  t.appendChild(d)
}

function removeRow () {
  const ra = Array.from(document.querySelectorAll('.row'))
  const r = ra.slice(-1)[0]

  if (ra.length > 0 && typeof r !== 'undefined') {
    r.remove()

    document.getElementById('container').querySelector('br')?.remove()
  }
}

function addArrow (dir) {
  const r = Array.from(document.querySelectorAll('.row')).slice(-1)[0]
  const d = document.createElement('div')

  d.classList.add(dir)

  r.appendChild(d)
}

function moreOptions () {
  const m = document.getElementById('more')
  const c = document.getElementById('container')
  
  if(m.style.display === 'none') {
    m.style.display = ''
    c.style.display = 'none'
  } else {
    m.style.display = 'none'
    c.style.display = ''
  }

  document.getElementById('about').style.display = 'none'
  document.getElementById('help').style.display = 'none'
  document.getElementById('settings').style.display = 'none'
}

function display (panel) {
  const panels = ['about', 'container', 'help', 'settings']

  panels.map((p) => document.getElementById(p))
    .forEach((p) => {
      if (p.id === panel) {
        p.style.display = ''
      } else {
        p.style.display = 'none'
      }
    })

    document.getElementById('more').style.display = 'none'
}

function getRow () {
  const r = Array.from(document.querySelectorAll('.row')).slice(-1)[0]

  return r
}

function getScoreboard () {
  const s = Array.from(document.querySelectorAll('.score')).slice(-1)[0]
  const correct = s.children[0]
  const misplaced = s.children[1]

  return {
    correct,
    misplaced
  }
}

function status (message, type = 'success') {
  const s = document.createElement('div')

  s.classList.add('status', type)

  s.appendChild(document.createTextNode(message))

  document.getElementById('container').appendChild(s)
}

function generatePossibilities (num, alignments) {
  if (num === 1) {
    return alignments.slice(0)
  }

  const suffixes = generatePossibilities(num - 1, alignments)
  const ret = []

  alignments.forEach((a) => {
    suffixes.forEach((s) => {
      ret.push([a].concat(s))
    })
  })

    return ret
  }

function judgeGuess(answer, guess) {
 /**
  * @param answer e.g. ["red", "green", "blue", "blue"]
  * @param guess e.g. ["blue, green", "yellow", "red"]
  * return e.g. { bothCorrect: 1, colorCorrect: 2 }
  */
  const retVal = {
    correct: 0,
    misplaced: 0
  }
  const unaccountedForAnswers = []
  const unaccountedForGuesses = []

  for (let i = 0; i < answer.length; i++) {
    const a = answer[i]
    const g = guess[i]

    if (a === g) {
      retVal.correct++
    } else {
      unaccountedForAnswers.push(answer[i])
      unaccountedForGuesses.push(guess[i])
    }
  }

  unaccountedForAnswers.forEach((a) => {
    const guessIndex = unaccountedForGuesses.indexOf(a)

    if (guessIndex !== -1) {
      retVal.misplaced++
      unaccountedForGuesses.splice(guessIndex, 1)
    }
  })

  return retVal
}

function guessContradictsSomeEvidence (guess, evidences) {
  for (let key in evidences) {
    let evidence = evidences[key]
    /*
     * Treat the guess like an answer and the evidence as a guess, and
     * see whether the judgment is the same.
     */

    let judgement = judgeGuess(guess, evidence.guess)

    if ((judgement.correct !== evidence.correct) || (judgement.misplaced !== evidence.misplaced)) {
      //console.log("guess", guess, "contradicts evidence", evidence.guess);

      return true
    }
  }

  return false
}

function quickRemoveFromArray (index, array) {
 /**
  * Removes and returns the element at the provided index from an array.
  * This function may shuffle/reorder the elements of the array for
  * efficiency reasons. For example, if you request to remove the first
  * element of the array, rather than reindexing every element in the
  * array (O(N)), this function may choose to swap the first and last
  * element of the array, and then remove the last element from the
  * array (O(1)).
  */
  const arrayLength = array.length

  if (index >= arrayLength || index < 0) {
    throw new Error("Tried to access index " + index + " from array of length " + arrayLength)
  }

  if (arrayLength === 1) {
    return array.pop()
  }

  const retVal = array[index]
  const lastElement = array.pop()
  array[index] = lastElement

  return retVal
}

function generateGuess (evidence) {
 /**
  * Returns an array e.g. ["red", "green", "blue"] or null to indicate
  * that there are no possible guesses left. It randomly selects one of
  * the guesses from the provided `gameState` parameter, and removes
  * that guess from the list of possible guesses. This function may also
  * "shuffle" or reorder the elements in the possible guesses list for
  * efficiency reasons.
  */

  let guessIndex = Math.floor(Math.random() * possibilities.length)
  let guess = quickRemoveFromArray(guessIndex, possibilities)

  while (guessContradictsSomeEvidence(guess, evidence)) {
    if (possibilities.length < 1) {
      return null
    }

    guessIndex = Math.floor(Math.random() * possibilities.length)

    guess = quickRemoveFromArray(guessIndex, possibilities)
  }

  if (typeof guess !== 'object' || guess.constructor.name !== 'Array') {
    throw new Error("Expected guess to be an array, but it was a(n) " + (typeof guess))
  }

  return guess
}

function addGuess (guess, correct, misplaced) {
  const shortToLong = {
    u: 'up',
    d: 'down',
    l: 'left',
    r: 'right'
  }

  const keys = Object.keys(shortToLong)

  guess.forEach((alignment) => {
    if (keys.indexOf(alignment) < 0) {
      throw new Error('Expected one of up, down, left, or right, but found ' + alignment)
    }

    addArrow(shortToLong[alignment])
  })

  const row = getRow()
  row.dataset.evidence = JSON.stringify({
    guess
  })
}

function nextGuess () {
  const evidence = []

  document.getElementById('container').style.display = ''
  document.getElementById('more').style.display = 'none'
  document.getElementById('about').style.display = 'none'
  document.getElementById('help').style.display = 'none'
  document.getElementById('settings').style.display = 'none'

  Array.from(document.getElementsByClassName('status'))
    .forEach((s) => s.remove())

  if (getRow().style.display !== 'none') {
    const sb = getScoreboard()
    const correct = parseInt(sb.correct.innerText)
    const misplaced = parseInt(sb.misplaced.innerText)

    if (correct + misplaced > 4) {
      status('The sum of Correct and Misplaced must be less than 4.', 'warning')

      return
    }

    if (correct === 4) {
      status('Success! Try again.', 'success')

      document.getElementById('next').style.display = 'none'

      return
    }

    const e = JSON.parse(getRow().dataset.evidence)

    e['correct'] = correct
    e['misplaced'] = misplaced

    getRow().dataset.evidence = JSON.stringify(e)
  }

  const rows = Array.from(document.getElementById('container').querySelectorAll('.row'))
  
  for(r of rows) {
    if (typeof r.dataset.evidence !== 'undefined') {
      evidence.push(JSON.parse(r.dataset.evidence))
    }
  }

  const next = generateGuess(evidence)

  if (next === null) {
    document.getElementById('next').style.display = 'none'

    status('Ran out of possibilities to guess. There may be a mistake in the data you entered.', 'failure')
  } else {
    addRow()

    const row = getRow()

    row.dataset.guess = next
    row.style.display = 'inline-block'

    addGuess(next)
  }
}

function initAutomation () {
  const rows = Array.from(document.querySelectorAll('.row'))

  document.getElementById('container').style.display = ''
  document.getElementById('more').style.display = 'none'
  document.getElementById('about').style.display = 'none'
  document.getElementById('help').style.display = 'none'
  document.getElementById('settings').style.display = 'none'

  Array.from(document.getElementsByClassName('status'))
    .forEach((s) => s.remove())

  for (let i = 0; i < rows.length; i++) {
    removeRow()
  }

  addRow()

  getRow().style.display = 'none'

  document.querySelector('.status')?.remove()

  document.getElementById('next').style.display = ''

  possibilities = generatePossibilities(4, ['u', 'd', 'l', 'r'])

  nextGuess()
}

let possibilities = []

function updateTheme (t) {
  if (t === 'light') {
    document.body.style.background = 'white'
    document.body.style.color = 'black'

    Array.from(document.getElementsByTagName('button')).forEach(function (b) {
      b.className = 'light'
    })
  } else {
    document.body.style.background = 'black'
    document.body.style.color = 'white'

    Array.from(document.getElementsByTagName('button')).forEach(function (b) {
      b.className = 'dark'
    })
  }
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function selfTest () {
  /*
   * Test framework
   */
  const tests = {
    passed: 0,
    failed: 0,
    total: 0,
    message: ''
  }

  const check = '\u2714'
  const cross = '\u274C'

  const test = async function (label, func) {
    if (typeof func === 'undefined') {
      tests.message += '\n  ' + label + '\n'
    } else {
      tests.total++

      if (await func()) {
        tests.passed++
        tests.message += '    ' + check + ' ' + label + '\n'
      } else {
        tests.failed++
        tests.message += '    ' + cross + ' ' + label + '\n'
      }
    }
  }

  /*
   * Tests
   */
  
  const clickEvent = new MouseEvent('click')
  const shiftClickEvent = new MouseEvent('click', {'shiftKey': true})

  const more = document.getElementById('more')

  test('User Interface')

  test('Shows more options', function showMore () {
    moreOptions()

    return more.style.display !== 'none'
  })

  test('Hides more options', function hideMore () {
    moreOptions()

    return more.style.display === 'none'
  })

  const settings = document.getElementById('settings')

  test('Shows settings', function showSettings () {
    display('settings')

    return settings.style.display !== 'none'
  })

  /*
  const dark = document.getElementById('dark')
  const light = document.getElementById('light')

  await test('Changes theme', async function changesTheme () {
    return true
  })
  */

  const help = document.getElementById('help')

  test('Shows help', function showHelp () {
    display('help')

    return help.style.display !== 'none'
  })

  const about = document.getElementById('about')

  test('Shows about', function showAbout () {
    display('about')

    return about.style.display !== 'none'
  })

  const auto = document.getElementById('auto')

  test('Resets board and makes a first guess', function initTest () {
    initAutomation()

    return typeof JSON.parse(Array.from(
      document.querySelectorAll('.row')).slice(-1)[0].dataset.evidence
    ).correct === 'undefined'
  })

  let row = Array.from(document.querySelectorAll('.row')).slice(-1)[0]
  let score = Array.from(row.querySelectorAll('.score')).slice(-1)[0]

  test('Increases score on click', function incScores () {
    for (let i = 0; i < 4; i ++) {
      score.children[0].dispatchEvent(clickEvent)
      score.children[1].dispatchEvent(clickEvent)
    }

    return parseInt(score.children[0].innerText) === 4
  })

  test('Score wraps from 4 to 0', function loopsAroundMax () {
    score.children[0].dispatchEvent(clickEvent)

    return parseInt(score.children[0].innerText) === 0
  })

  test('Decreases score on shift-click', function decScores () {
    for (let j = 0; j < 4; j ++) {
      score.children[1].dispatchEvent(shiftClickEvent)
    }

    return parseInt(score.children[1].innerText) === 0
  })

  test('Score wraps from 0 to 4', function loopsAroundMin () {
    score.children[1].dispatchEvent(shiftClickEvent)

    return parseInt(score.children[1].innerText) === 4
  })

  const next = document.getElementById('next')

  await test('Hides next after success', async function hidesNextOnSuccess () {
    score.children[0].dispatchEvent(shiftClickEvent)
    score.children[1].dispatchEvent(clickEvent)
    next.dispatchEvent(clickEvent)

    return next.style.display === 'none'
  })

  const res = document.getElementById('testResults')

  res.value = tests.message + '\n  ' + ((tests.passed / tests.total * 100) + '').substring(0, 5) +
  '% of tests passed (' + tests.passed + '/' + tests.total + ').'

  // Has to be actively displayed to be scrolled.
  display('settings')
  res.scrollTop = res.scrollHeight
}

</script>
</body>
</html>